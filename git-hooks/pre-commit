#!/bin/bash

# Pre-commit hook to prevent committing secrets
# This hook checks for common API key patterns and prevents commits if found

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Patterns to check for (common API key formats)
PATTERNS=(
    # Google API keys (AIza...)
    "AIza[0-9A-Za-z_-]{35}"
    # AWS keys (AKIA...)
    "AKIA[0-9A-Z]{16}"
    # Autumn API keys (am_sk_live_...)
    "am_sk_live_[A-Za-z0-9]{40,}"
    # Generic secret patterns
    "secret['\"]?\s*[:=]\s*['\"][^'\"]{20,}['\"]"
    "api[_-]?key['\"]?\s*[:=]\s*['\"][^'\"]{20,}['\"]"
    "password['\"]?\s*[:=]\s*['\"][^'\"]{20,}['\"]"
    # Private keys
    "-----BEGIN PRIVATE KEY-----"
    "-----BEGIN RSA PRIVATE KEY-----"
    "-----BEGIN OPENSSH PRIVATE KEY-----"
)

# Files to exclude from checking
EXCLUDE_PATTERNS=(
    "node_modules/"
    ".git/"
    ".next/"
    "dist/"
    "build/"
    "coverage/"
    ".wrangler/"
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check for secrets in staged files
FOUND_SECRETS=0

for file in $STAGED_FILES; do
    # Skip excluded patterns
    SKIP=0
    for exclude in "${EXCLUDE_PATTERNS[@]}"; do
        if [[ "$file" == *"$exclude"* ]]; then
            SKIP=1
            break
        fi
    done
    
    if [ $SKIP -eq 1 ]; then
        continue
    fi
    
    # Check file content for secret patterns
    for pattern in "${PATTERNS[@]}"; do
        if git show ":$file" 2>/dev/null | grep -E "$pattern" > /dev/null 2>&1; then
            echo -e "${RED}❌ SECURITY: Potential secret detected in $file${NC}"
            echo -e "${YELLOW}Pattern: $pattern${NC}"
            FOUND_SECRETS=1
        fi
    done
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo -e "${RED}❌ Commit blocked: Secrets detected in staged files${NC}"
    echo ""
    echo "To fix this:"
    echo "1. Remove the secret from the file"
    echo "2. If the secret was already committed, run: git filter-repo --replace-text /path/to/secrets.txt"
    echo "3. Stage the changes again and commit"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

exit 0

